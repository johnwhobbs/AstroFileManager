name: Claude Code Issue Fixer

on:
  issues:
    types: [opened, labeled]

jobs:
  fix-issue:
    # Only run if the issue has a specific label (optional safety measure)
    if: contains(github.event.issue.labels.*.name, 'claude-fix')
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.CLAUDE_CODE_TOKEN }}
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'
      
      - name: Install Claude Code
        run: |
          pip install claude-code
      
      - name: Create development branch
        run: |
          git config user.name "Claude Code Bot"
          git config user.email "bot@claudecode.ai"
          BRANCH_NAME="fix-issue-${{ github.event.issue.number }}"
          git checkout -b "$BRANCH_NAME"
      
      - name: Run Claude Code to fix issue
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          claude-code --issue "${{ github.event.issue.number }}" \
                       --repo "${{ github.repository }}" \
                       --branch "fix-issue-${{ github.event.issue.number }}"
      
      - name: Commit and push changes
        run: |
          git add .
          git commit -m "Fix issue #${{ github.event.issue.number }}: ${{ github.event.issue.title }}" || echo "No changes to commit"
          git push origin "fix-issue-${{ github.event.issue.number }}"
      
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.CLAUDE_CODE_TOKEN }}
          branch: "fix-issue-${{ github.event.issue.number }}"
          base: development
          title: "Fix issue #${{ github.event.issue.number }}: ${{ github.event.issue.title }}"
          body: |
            Automated fix for issue #${{ github.event.issue.number }}
            
            This PR was automatically generated by Claude Code.
            
            Closes #${{ github.event.issue.number }}
