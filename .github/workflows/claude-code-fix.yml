name: Claude Code Issue Fixer

on:
  issues:
    types: [labeled]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  claude-fix:
    if: github.event.label.name == 'claude-fix'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Run Claude Code
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          settings: |
            {
              "permissions": {
                "allow": [
                  "Read",
                  "Edit",
                  "CreateFile",
                  "StrReplace",
                  "View",
                  "GlobTool",
                  "GrepTool"
                ]
              },
              "defaultMode": "acceptEdits"
            }
          claude_args: |
            --max-turns 30
          prompt: |
            REPOSITORY: ${{ github.repository }}
            WORKING DIRECTORY: /home/runner/work/AstroFileManager/AstroFileManager
            
            ISSUE #${{ github.event.issue.number }}: ${{ github.event.issue.title }}
            
            DESCRIPTION:
            ${{ github.event.issue.body }}
            
            ⚠️ CRITICAL INSTRUCTIONS - READ FIRST:
            
            1. EXPLORING FILES:
               - To list directory contents: Use View tool on the directory path (e.g., View on ".")
               - To read a file: Use View tool on the file path with extension (e.g., "README.md")
               - NEVER use View/Read on a directory path expecting file contents
               - Use GlobTool to find files (e.g., "**/*.py" finds all Python files)
            
            2. YOUR TASK:
               - Implement the changes described in the issue
               - This is a Python astrophotography file management application
               - Write beginner-friendly code with comments
               - Add docstrings to all functions
               - Include basic error handling
               - Follow PEP 8 style guidelines
            
            3. WORKFLOW:
               - First: Use View on "." to see the repository structure
               - Then: Use GlobTool or View on specific files to understand the code
               - Next: Make your changes using CreateFile or StrReplace
               - Finally: The GitHub Action will automatically commit and create a PR
            
            Start by viewing the current directory structure, then proceed with the task.
